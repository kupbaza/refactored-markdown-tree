# docs.safebox.zone 다국어(EN/JA) 운영 가이드 (GitBook + Cloudflare)

본 문서는 **docs.safebox.zone** 사이트에서 영어(EN)/일본어(JA) 다국어를 GitBook Variants로 운영할 때의 **기본 언어 설정**, **리다이렉트 설계**, **브라우저 언어 자동 분기(Cloudflare Workers)** 구현 방법을 설명합니다.  
문서 톤은 인터넷 서비스 온라인 매뉴얼 표준을 따릅니다.

---

## 1) 결론 요약

- **기본 언어를 영어로 설정**: 가능. GitBook에서 EN Variant를 **Default**로 지정하면 루트(`/`)가 EN로 서빙됩니다.
- **브라우저 언어 자동 감지→해당 언어 자동 전환**: GitBook에 **내장 기능 없음**.  
  ➜ **대안**: Cloudflare Workers(또는 에지 프록시)에서 `Accept-Language` 판독 후 **최초 방문 1회 리다이렉트** 구현 + `lang` 쿠키로 사용자 선택 기억.

---

## 2) 기본 언어(EN)로 전환 방법

1. GitBook 콘솔 → **Docs Site → Settings → Structure/Spaces(Variants)**  
2. 영어 Variant의 옵션 메뉴에서 **Set as default** 지정  
3. 적용 결과
   - 루트(`/`) = EN(영문) 서빙
   - 기존 언어 경로는 GitBook의 자동 리다이렉트/슬러그 정리로 대부분 호환
   - 외부 공유 링크 안정성 확보를 위해 **아래 리다이렉트 표**도 함께 구성 권장

---

## 3) 브라우저 언어 자동 감지 지원 여부

- GitBook은 UI 문자열(라벨 등) 현지화는 제공하나, **콘텐츠 Variant를 브라우저 언어로 자동 전환/리다이렉트하는 기능은 제공하지 않습니다.**
- GitBook이 호스팅/헤더 주입 커스텀 JS를 허용하지 않으므로, **도메인 앞단(예: Cloudflare Workers, CDN/에지 프록시)**에서 `Accept-Language` 헤더를 판독해 **최초 방문시에만** 해당 언어 Variant 경로로 리다이렉트하는 방식을 권장합니다. 이후 사용자가 수동으로 언어를 바꾼 경우에는 쿠키를 두어 **재방문 시 리다이렉트하지 않도록** 합니다.
- **Cloudflare Workers** 또는 다른 에지 레이어에서 처리하는게 좋을것 같습니다.

https://community.cloudflare.com/t/browser-language-detection-and-redirect/427408?utm_source=chatgpt.com

---

## 4) 권장 운영 아키텍처

- **EN = 기본(루트)**, **JA = `/ja/` 슬러그**로 운용
- 최초 방문 시 **에지에서 1회성 감지**:
  - `Accept-Language`가 `ja` → `/ja/`로 302
  - 그 외 → `/`(EN 유지)
  - 이후에는 사용자의 명시 선택을 **쿠키(`lang=en|ja`)**로 우선
  - 운영 시에는 **사용자가 언어 선택기를 통해 전환할 때 `lang` 쿠키를 갱신**하도록 간단한 중간 경로(예: `/set-lang?l=ja` → 302 `/ja/` + `Set-Cookie`)를 추가하면 UX가 좋아집니다.
    
- GitBook의 **Site Redirects**는 개별 경로 리다이렉트 관리에 유용하지만, **브라우저 언어 감지 로직을 내장하지는 않습니다**. 따라서 위와 같은 에지 레벨 처리가 현실적입니다.
- GitBook **Site Redirects**로 과거 링크/슬러그 정리(표 참조)
- 외부 공유 시에는 가능하면 **언어 슬러그 명시**(예: 일본 파트너 공유 = `/ja/...`)

---

## 5) 리다이렉트 표 (영문을 기본으로 전환 시)

> 전제: EN=루트(슬러그 없음), JA=`/ja/`  
> 목적: **과거 루트=JA**였던 링크를 404 없이 보전 + EN 루트 정착

| 우선순위 | From(패턴) | To(대상) | 코드 | 비고 |
|---:|---|---|:---:|---|
| 1 | `/ja` (정확히) | `/ja/` | 301 | 슬래시 정규화 |
| 2 | `/ja/*` | `/ja/:splat` | 301 | JA 내부 경로 유지 |
| 3 | `/en` (정확히) | `/` | 301 | EN은 루트가 기본 |
| 4 | `/en/*` | `/:splat` | 301 | EN 내부 경로는 루트로 |
| 5 | `/` | `/` | — | 루트=EN 유지(규칙 불필요) |
| 6 | `/*` (선별) | `/ja/:splat` | 302 → 2~4주 후 301 또는 제거 | **과거 루트=JA였을 때 상위 대표 경로**만 임시 운용 |

https://gitbook.com/docs/publishing-documentation/site-redirects?utm_source=chatgpt.com

### 등록 위치 (GitBook)
- **Site → Settings → Domain & redirects → Site redirects**
- 와일드카드(`*`, `:splat`) 지원
- 1–4번은 **상시**, 6번은 **전환 기간만** 운용 권장

---

## 6) Cloudflare 설정: 브라우저 언어 자동 분기 (2안)

### A안) Cloudflare 프록시(주황 구름 ON) + Worker 라우팅 (**권장**)

1. **DNS 확인**
   - `docs.safebox.zone` CNAME → GitBook 호스트(예: `hosting.gitbook.io`)
   - **프록시 ON(🟧)** 으로 전환해 에지 집행 활성화
2. **Worker 생성**
   - Cloudflare Dashboard → **Workers & Pages → Create application → Create Worker → Deploy**
3. **라우트 연결**
   - Workers & Pages → 해당 Worker → **Settings → Domains & Routes → Add route**
   - `docs.safebox.zone/*` 추가(또는 필요한 서브패스)
   - 여러 라우트가 있을 경우 **구체적 경로 우선**
4. **동작 원칙**
   - **최초 방문**(`"/"` 혹은 최상위 진입 경로)에서만 `Accept-Language` 판독
   - `ja` 선호 시 `/ja/`로 **302** + `Set-Cookie: lang=ja`
   - 그 외 EN 유지 + `Set-Cookie: lang=en`
   - **재방문 시 쿠키 우선**(사용자 수동 전환 존중)

> 보안 권장: `SameSite=Lax; Secure; Path=/; Max-Age=2592000`


---

### B안) GitBook 측 제약으로 프록시가 불가할 때 (우회)

- **B-1. 별도 진입 호스트** `edge-docs.safebox.zone`에 Worker 연결 → 최초 진입만 이쪽으로 유도, 감지 후 `docs.safebox.zone/{ja|}`로 302
- **B-2. 회사 포털/홈페이지**에서 언어 감지 후 GitBook URL을 분기
- **B-3. 자동 감지 없이** GitBook의 Site Redirects + 언어 선택 UX만 운영

---

## 7) Cloudflare Worker 코드 스니펫 (예시)

> 실제 슬러그/예외 경로/보안 정책에 맞게 조정하세요.

```js
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // 사용자가 선택한 언어 쿠키가 있으면 존중
    const cookie = request.headers.get("Cookie") || "";
    const chosen = /(?:^|;\s*)lang=(en|ja)(?:;|$)/.exec(cookie)?.[1];

    // 루트 또는 최상위 진입에서만 1회 감지
    const isEntry = url.pathname === "/" || /^\/(docs|guide)\/?$/.test(url.pathname);

    if (!chosen && isEntry) {
      const al = request.headers.get("Accept-Language") || "";
      const preferJa = /^ja(\b|[-,;])/i.test(al);
      const dest = preferJa ? "/ja/" : "/";

      if (url.pathname !== dest) {
        url.pathname = dest;
        return new Response(null, {
          status: 302,
          headers: {
            "Location": url.toString(),
            "Set-Cookie":
              `lang=${preferJa ? "ja" : "en"}; Path=/; Max-Age=2592000; SameSite=Lax; Secure`,
          },
        });
      }
    }

    // 그 외 요청은 원본(GitBook)으로 프록시
    return fetch(request);
  }
}


### (선택) 언어 선택기와 쿠키 연동 엔드포인트

- `/set-lang?l=ja|en` → `Set-Cookie: lang=...` 설정 후 **302**로 해당 언어 루트로 이동
    
- 예: `/set-lang?l=ja` → 302 `/ja/`
    

---

## 8) 운영 체크리스트

-  GitBook에서 **EN Variant = Default** 설정(루트=EN)
    
-  **리다이렉트 표**(상단 1–4번 상시 / 6번 임시) GitBook에 등록
    
-  **Cloudflare A안**(프록시+Worker) 또는 **B안**(우회) 중 택1
    
-  스테이징 서브도메인으로 **사전 리허설** 진행
    
-  언어 선택기와 `lang` 쿠키 동기화(선택)
    
-  전환 후 2~4주 경과 시, 임시 302 규칙(표 6번) → 301 전환 또는 제거